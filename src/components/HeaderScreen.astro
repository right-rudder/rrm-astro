---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

const { content } = Astro.props;
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/*.{jpeg,jpg,png,gif,webp,avif}"
);

// Helper to get image metadata for a given path
async function getImageMeta(path) {
  if (!images[path]) return undefined;
  const mod = await images[path]();
  return mod.default;
}

const basePath = content.imagePath;
const avifPath = basePath.replace(/\.(jpeg|jpg|png|gif|webp)$/, ".avif");
const webpPath = basePath.replace(/\.(jpeg|jpg|png|gif)$/, ".webp");

const [avifMeta, webpMeta, jpegMeta] = await Promise.all([
  getImageMeta(avifPath),
  getImageMeta(webpPath),
  getImageMeta(basePath),
]);
---

{/** Preload LCP image in all available formats for optimal LCP */}
<Fragment>
  <head>
    {
      avifMeta && (
        <link
          rel="preload"
          as="image"
          href={avifMeta.src}
          imagesrcset={avifMeta.src}
          type="image/avif"
          fetchpriority="high"
        />
      )
    }
    {
      webpMeta && (
        <link
          rel="preload"
          as="image"
          href={webpMeta.src}
          imagesrcset={webpMeta.src}
          type="image/webp"
          fetchpriority="high"
        />
      )
    }
    {
      jpegMeta && (
        <link
          rel="preload"
          as="image"
          href={jpegMeta.src}
          imagesrcset={jpegMeta.src}
          type="image/jpeg"
          fetchpriority="high"
        />
      )
    }
  </head>
  <header
    class="relative lg:mt-0 lg:min-h-[90vh] bg-gray-800 text-white flex flex-col items-center justify-center overflow-hidden"
  >
    {
      /* LCP image: AVIF/WebP/JPEG responsive, preload, fetchpriority, aspect-ratio */
    }
    <picture>
      {avifMeta && <source srcset={avifMeta.src} type="image/avif" />}
      {webpMeta && <source srcset={webpMeta.src} type="image/webp" />}
      {
        jpegMeta && (
          <img
            src={jpegMeta.src}
            alt={content.imageAlt}
            width="1920"
            height="720"
            style="aspect-ratio: 16/9;"
            class="absolute inset-0 -z-0 object-cover object-center w-full h-full animate-slow-zoom"
            loading="eager"
            fetchpriority="high"
            decoding="async"
          />
        )
      }
    </picture>
    <div
      class="absolute bg-gradient-to-b from-primary-dark-950/50 to-primary-dark-950/60 w-full h-full z-0"
    >
    </div>
    <!-- Text -->
    <div
      class="text-white mt-24 lg:mt-0 text-center pb-12 lg:pb-0 lg:text-left z-10 flex flex-col items-center gap-4 px-5 h-full lg:pt-28 justify-center"
    >
      {
        content.stars && (
          <div class="flex opacity-95 animate-fade-from-top">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-16 md:size-20 text-accent-400 hover:text-accent-200 duration-500 ease-out"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"
              />
            </svg>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-16 md:size-20 text-accent-400 hover:text-accent-200 duration-500 ease-out"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"
              />
            </svg>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-16 md:size-20 text-accent-400 hover:text-accent-200 duration-500 ease-out"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"
              />
            </svg>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-16 md:size-20 text-accent-400 hover:text-accent-200 duration-500 ease-out"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"
              />
            </svg>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-16 md:size-20 text-accent-400 hover:text-accent-200 duration-500 ease-out"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"
              />
            </svg>
          </div>
        )
      }
      <h1
        class="text-4xl md:text-5xl lg:text-6xl drop-shadow-lg xl:text-7xl text-center font-black tracking-normal text-gray-100 animate-fade-from-top"
        set:html={content.headerH1}
      />
      <h2
        class="text-lg/6 mt-3 font-semibold tracking-wide text-center max-w-4xl animate-fade-from-bottom"
        set:html={content.paragraph}
      />
      <div
        class="mt-6 flex flex-wrap justify-center align-middle items-center gap-6 z-10"
      >
        {
          content.buttons.map((btn) => (
            <a
              href={btn.link}
              class={`${btn.primary ? "btn-primary" : "btn-white"} w-full md:w-auto animate-fade-from-bottom`}
            >
              {btn.name}
            </a>
          ))
        }
      </div>
    </div>
  </header>
</Fragment>
